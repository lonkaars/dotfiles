#!/bin/sh
progname="$(basename "$0")"
showmode() {
	! [ -n "$FROM_PROMPT" ] && return
	! [ -t 1 ] && return

	mode=" ($1)"
	col=$(( $(tput cols) - $(echo "$mode" | wc -L) + 1 ))
	printf '\e[1A\e['$col'G\e[1;30m%s\e[0m\n' "$mode"
}

mode_west() {
	showmode 'west'
	[ -z "$*" ] && set -- build
	exec west "$@"
}
[ -e "west.yml" ] && mode_west "$@"

mode_cmake() {
	showmode 'cmake'
	builddir="build"

	[ "$*" = "clean" ] && exec rm -rf "$builddir"

	export CMAKE_GENERATOR="Ninja"

	# re-run configuration if fresh or CMakeLists was changed
	if [ ! -e "$builddir/build.ninja" ] ||
		[ "CMakeLists.txt" -nt "$builddir/build.ninja" ] ; then
		cmake --log-level WARNING -B "$builddir" || exit $?
	fi

	# build
	cmake --build "$builddir" -- "$@"
	ec=$?

	# generate vim tags (continue after mk exits)
	ninja -C "$builddir" -t deps | sed -n 's/^ \{4\}//p' | sort -u | ctags -L - -f "$builddir/tags" 2>/dev/null &

	exit $ec
}
[ -e "CMakeLists.txt" ] && mode_cmake "$@"

mode_make() {
	showmode 'make'
	exec make "$@"
}
[ -e "makefile" ] && mode_make "$@"
[ -e "Makefile" ] && mode_make "$@"

mode_latexmk() {
	showmode 'latexmk'

	[ "$*" = "clean" ] && exec latexmk -c

	exec latexmk "$@"
}
[ -e "latexmkrc" ] && mode_latexmk "$@"
[ -e ".latexmkrc" ] && mode_latexmk "$@"

echo "$progname: unable to determine project build system!" >&2
exit 1

